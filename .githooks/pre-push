#!/bin/bash
# Pre-push hook to check code formatting with clang-format
# This runs before pushing to remote

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "Running pre-push formatting check..."

# Get list of files that will be pushed
FILES_TO_CHECK=$(git diff --name-only --diff-filter=ACM origin/$(git rev-parse --abbrev-ref HEAD) 2>/dev/null | grep -E '\.(cpp|hpp|h)$' || \
  git diff --name-only --diff-filter=ACM HEAD@{upstream} 2>/dev/null | grep -E '\.(cpp|hpp|h)$' || \
  git diff --name-only --diff-filter=ACM HEAD | grep -E '\.(cpp|hpp|h)$')

if [ -z "$FILES_TO_CHECK" ]; then
  echo -e "${GREEN}No C++ files to check.${NC}"
  exit 0
fi

FAILED_FILES=()

for file in $FILES_TO_CHECK; do
  # Skip if file doesn't exist
  if [ ! -f "$file" ]; then
    continue
  fi

  # Skip build directories
  if [[ "$file" == build* ]] || [[ "$file" == */build/* ]]; then
    continue
  fi

  # Check if file needs formatting
  if ! clang-format --dry-run --Werror "$file" >/dev/null 2>&1; then
    FAILED_FILES+=("$file")
    echo -e "${RED}✗ $file needs formatting${NC}"
  fi
done

if [ ${#FAILED_FILES[@]} -gt 0 ]; then
  echo ""
  echo -e "${RED}Error: The following files are not properly formatted:${NC}"
  for file in "${FAILED_FILES[@]}"; do
    echo "  - $file"
  done
  echo ""
  echo -e "${YELLOW}To fix, run:${NC}"
  echo "  clang-format -i ${FAILED_FILES[*]}"
  echo ""
  echo -e "${RED}Push blocked until files are formatted.${NC}"
  exit 1
fi

echo -e "${GREEN}✓ All files are properly formatted${NC}"
exit 0
