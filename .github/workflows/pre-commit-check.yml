name: Pre-commit Checks

on:
  pull_request:
    branches: [ main, develop ]

jobs:
  format-check:
    name: Format Check (Pre-commit)
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for proper diff

    - name: Install clang-format
      run: |
        sudo apt-get update
        # Install specific version to match local development (clang-format-14)
        # This ensures consistent formatting across environments
        sudo apt-get install -y clang-format-14 || sudo apt-get install -y clang-format
        # Create symlink if needed
        if ! command -v clang-format &> /dev/null; then
          sudo ln -s /usr/bin/clang-format-14 /usr/bin/clang-format || true
        fi
        clang-format --version

    - name: Check code formatting
      run: |
        # Get changed files in PR
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          CHANGED_FILES=$(git diff --name-only --diff-filter=ACM "$BASE_SHA" "$HEAD_SHA" | grep -E '\.(cpp|hpp|h)$' || true)
        else
          CHANGED_FILES=$(git diff --name-only --diff-filter=ACM HEAD~1 HEAD | grep -E '\.(cpp|hpp|h)$' || true)
        fi

        if [ -z "$CHANGED_FILES" ]; then
          echo "No C++ files changed, skipping format check"
          exit 0
        fi

        FAILED_FILES=()
        while IFS= read -r file; do
          if [ -f "$file" ] && ! clang-format --dry-run --Werror "$file" >/dev/null 2>&1; then
            FAILED_FILES+=("$file")
          fi
        done <<< "$CHANGED_FILES"

        if [ ${#FAILED_FILES[@]} -gt 0 ]; then
          echo "::error::Formatting errors found in the following files:"
          for file in "${FAILED_FILES[@]}"; do
            echo "  - $file"
            echo "    Fix with: clang-format -i $file"
          done
          exit 1
        else
          echo "âœ“ All changed files are properly formatted"
        fi
