#!/bin/bash
# Pre-commit hook to check code formatting with clang-format

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "Running clang-format check..."

# Get list of staged C++ files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(cpp|hpp|h)$')

if [ -z "$STAGED_FILES" ]; then
  echo -e "${GREEN}No C++ files to check.${NC}"
  exit 0
fi

FAILED_FILES=()

for file in $STAGED_FILES; do
  # Skip if file doesn't exist (was deleted)
  if [ ! -f "$file" ]; then
    continue
  fi

  # Check if file needs formatting
  if ! clang-format --dry-run --Werror "$file" >/dev/null 2>&1; then
    FAILED_FILES+=("$file")
    echo -e "${RED}✗ $file needs formatting${NC}"
  fi
done

if [ ${#FAILED_FILES[@]} -gt 0 ]; then
  echo ""
  echo -e "${RED}Error: The following files are not properly formatted:${NC}"
  for file in "${FAILED_FILES[@]}"; do
    echo "  - $file"
  done
  echo ""
  echo -e "${YELLOW}To fix, run:${NC}"
  echo "  clang-format -i ${FAILED_FILES[*]}"
  echo ""
  echo -e "${YELLOW}Or to auto-format all staged files:${NC}"
  echo "  git diff --cached --name-only --diff-filter=ACM | grep -E '\.(cpp|hpp|h)$' | xargs clang-format -i && git add -u"
  echo ""
  exit 1
fi

echo -e "${GREEN}✓ All files are properly formatted${NC}"
exit 0
