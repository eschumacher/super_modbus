#!/bin/bash
# Pre-push hook to check code formatting with clang-format
# This runs before pushing to remote

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "Running pre-push formatting check..."

# Pre-push hook receives refs via stdin: <local ref> <local sha1> <remote ref> <remote sha1>
# Collect all files being pushed across all refs
FILES_TO_CHECK=""
while read local_ref local_sha remote_ref remote_sha; do
  # Skip if this is a delete operation (local_sha is all zeros)
  if [ "$local_sha" = "0000000000000000000000000000000000000000" ]; then
    continue
  fi

  # Get files changed in commits being pushed
  if [ "$remote_sha" != "0000000000000000000000000000000000000000" ]; then
    # Normal push: diff between remote and local (commits being pushed)
    changed_files=$(git diff --name-only --diff-filter=ACM "$remote_sha" "$local_sha" 2>/dev/null | grep -E '\.(cpp|hpp|h)$' || true)
  else
    # New branch: all files in the commits being pushed
    changed_files=$(git diff --name-only --diff-filter=ACM --root "$local_sha" 2>/dev/null | grep -E '\.(cpp|hpp|h)$' || true)
  fi

  if [ -n "$changed_files" ]; then
    FILES_TO_CHECK="${FILES_TO_CHECK}${changed_files}"$'\n'
  fi
done

# Remove duplicates and empty lines
FILES_TO_CHECK=$(echo "$FILES_TO_CHECK" | sort -u | grep -v '^$')

if [ -z "$FILES_TO_CHECK" ]; then
  echo -e "${GREEN}No C++ files to check.${NC}"
  exit 0
fi

FAILED_FILES=()

for file in $FILES_TO_CHECK; do
  # Skip if file doesn't exist
  if [ ! -f "$file" ]; then
    continue
  fi

  # Skip build directories
  if [[ "$file" == build* ]] || [[ "$file" == */build/* ]]; then
    continue
  fi

  # Check if file needs formatting
  if ! clang-format --dry-run --Werror "$file" >/dev/null 2>&1; then
    FAILED_FILES+=("$file")
    echo -e "${RED}✗ $file needs formatting${NC}"
  fi
done

if [ ${#FAILED_FILES[@]} -gt 0 ]; then
  echo ""
  echo -e "${RED}Error: The following files are not properly formatted:${NC}"
  for file in "${FAILED_FILES[@]}"; do
    echo "  - $file"
  done
  echo ""
  echo -e "${YELLOW}To fix, run:${NC}"
  echo "  clang-format -i ${FAILED_FILES[*]}"
  echo ""
  echo -e "${RED}Push blocked until files are formatted.${NC}"
  exit 1
fi

echo -e "${GREEN}✓ All files are properly formatted${NC}"
exit 0
